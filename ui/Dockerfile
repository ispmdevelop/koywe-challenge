
# 1Ô∏è‚É£ Use official Node.js image as the base
FROM node:22 AS builder

# 2Ô∏è‚É£ Set working directory
WORKDIR /app

# 3Ô∏è‚É£ Copy package.json and lock file to install dependencies
COPY package.json package-lock.json ./  

# 4Ô∏è‚É£ Install dependencies (ignoring devDependencies for production)
RUN npm install --legacy-peer-deps

# 5Ô∏è‚É£ Copy the rest of the app
COPY . .

# 6Ô∏è‚É£ Build the Next.js app
RUN npm run build

# 7Ô∏è‚É£ Use a smaller image for the final container
FROM node:22 AS runner

# 8Ô∏è‚É£ Set environment variable (prevents unnecessary rebuilds)
ENV NODE_ENV=production

# 9Ô∏è‚É£ Set working directory
WORKDIR /app

# üîü Copy only the necessary files from the builder stage
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/package.json ./
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/postcss.config.mjs ./

# 1Ô∏è‚É£1Ô∏è‚É£ Expose port 8080 instead of 3000
EXPOSE 8080

# 1Ô∏è‚É£2Ô∏è‚É£ Start Next.js on port 8080
CMD ["npm", "run", "start", "--", "-p", "8080"]
